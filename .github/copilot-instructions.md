# GitHub Copilot Instructions for Chef Foundation

## 1. Repository Overview & Structure

### Project Purpose
Chef Foundation is a native platform package that contains the required dependencies used for building Chef Omnibus packages. It provides a stable foundation of dependencies that are compiled ahead of time, reducing build times for Chef Omnibus builds and enabling easier testing of Chef against consistent dependency versions.

### Repository Structure
```
chef-foundation/
├── .expeditor/                    # Expeditor CI/CD configuration
│   ├── config.yml                 # Main Expeditor configuration
│   ├── verify.pipeline.yml        # PR verification pipeline
│   ├── release.omnibus.yml        # Release build configuration
│   ├── adhoc-canary.omnibus.yml   # Canary build configuration
│   └── run_linux_tests.sh         # Linux test execution script
├── .github/                       # GitHub repository configuration
│   ├── CODEOWNERS                 # Code ownership rules
│   ├── ISSUE_TEMPLATE/             # Issue templates
│   └── copilot-instructions.md    # This file
├── config/
│   └── projects/
│       └── chef-foundation.rb     # Omnibus project definition (MODIFY)
├── docs/                          # Documentation
│   └── chef_foundation.md         # Project specification
├── expeditor-ruby/                # Expeditor Ruby scripts
├── files/                         # Static files for packaging
├── package-scripts/               # Pre/post install scripts
├── resources/                     # Platform-specific packaging resources
├── test/                          # Test files (MODIFY/EXTEND)
│   ├── fips_test.rb               # FIPS mode testing
│   └── open_ssl_test.rb           # OpenSSL testing
├── Gemfile                        # Ruby dependencies (MODIFY)
├── Rakefile                       # Rake task definitions (MODIFY)
├── omnibus.rb                     # Omnibus configuration (MODIFY)
├── omnibus_overrides.rb           # Version overrides (CRITICAL - MODIFY)
├── VERSION                        # Current version (AUTO-GENERATED)
└── CHANGELOG.md                   # Release notes (AUTO-GENERATED)
```

### Technologies Used
- **Ruby 3.1+**: Primary programming language
- **Omnibus**: Build system for creating native packages
- **Omnibus Software**: Dependency definitions and build recipes
- **Minitest**: Testing framework
- **Chefstyle/Cookstyle**: Ruby linting and style enforcement
- **Expeditor**: CI/CD automation platform
- **Buildkite**: Build execution platform

### Critical File Modification Guidelines

#### ✅ SAFE TO MODIFY:
- `config/projects/chef-foundation.rb` - Omnibus project configuration
- `omnibus_overrides.rb` - Dependency version overrides (CRITICAL)
- `Gemfile` - Ruby gem dependencies
- `Rakefile` - Build and test tasks
- `omnibus.rb` - Omnibus configuration
- `test/*.rb` - Test files (extend for new functionality)
- Documentation files (`.md`)

#### ⚠️ MODIFY WITH CAUTION:
- `.expeditor/config.yml` - Only modify with build team approval
- Package scripts in `package-scripts/`
- Resource files in `resources/`

#### ❌ NEVER MODIFY:
- `VERSION` - Auto-generated by Expeditor
- `CHANGELOG.md` - Auto-generated by Expeditor
- `.expeditor/verify.pipeline.yml` - Managed by build team
- `.expeditor/*.omnibus.yml` - Managed by build team

## 2. Development Workflow Integration

### Jira Integration Protocol
When provided with a Jira ID, follow this process:

1. **Fetch Jira Details**: Use atlassian-mcp-server to retrieve issue information
2. **Analyze Requirements**: Read story description, acceptance criteria, and technical requirements
3. **Plan Implementation**: Break down into phases with specific deliverables

### Workflow Phases

#### Phase 1: Initial Setup & Analysis
**Prompt**: "I'm starting Phase 1: Initial Setup & Analysis for [JIRA_ID]. I will:"
- Analyze Jira ticket requirements and acceptance criteria
- Examine current repository state and identify affected components
- Plan implementation approach with testing strategy
- Identify dependency version updates if needed
- Create detailed implementation plan

**Before proceeding**: "Phase 1 complete. Implementation plan ready. Do you want me to continue with Phase 2: Implementation?"

#### Phase 2: Implementation Phase
**Prompt**: "Starting Phase 2: Implementation for [JIRA_ID]. I will:"
- Implement required changes to omnibus configuration
- Update dependency versions in omnibus_overrides.rb
- Modify project definitions as needed
- Update documentation to reflect changes
- Ensure all changes follow Chef Foundation patterns

**Before proceeding**: "Phase 2 complete. Implementation finished. Do you want me to continue with Phase 3: Testing?"

#### Phase 3: Testing Phase (CRITICAL)
**Prompt**: "Starting Phase 3: Testing for [JIRA_ID]. This is CRITICAL for quality assurance. I will:"
- Create comprehensive unit tests for all new functionality
- Ensure >80% test coverage (NON-NEGOTIABLE REQUIREMENT)
- Test FIPS mode compatibility if applicable
- Test OpenSSL functionality and version verification
- Validate dependency overrides work correctly
- Run existing test suite to ensure no regressions
- Test platform-specific functionality if applicable

**Test Coverage Requirements**: 
- **MINIMUM 80% COVERAGE REQUIRED** - This is a hard requirement
- Test both positive and negative scenarios
- Include edge cases and error conditions
- Mock external dependencies appropriately
- Ensure tests are independent and deterministic

**Before proceeding**: "Phase 3 complete. All tests passing with >80% coverage. Do you want me to continue with Phase 4: Pull Request Creation?"

#### Phase 4: Pull Request Creation
**Prompt**: "Starting Phase 4: Pull Request Creation for [JIRA_ID]. I will:"
- Create branch with Jira ID name
- Commit changes with DCO signoff
- Push to remote repository
- Create PR with comprehensive description
- Apply appropriate labels based on change type

**Before proceeding**: "Phase 4 complete. Pull request created and ready for review."

## 3. Testing Requirements (CRITICAL - HARD REQUIREMENT)

### **>80% Test Coverage Mandate**
- **ALL implementations MUST achieve minimum 80% test coverage**
- **This is a NON-NEGOTIABLE requirement**
- **Coverage verification must be performed before PR creation**
- **Tests must cover both success and failure scenarios**

### Testing Framework: Minitest
```ruby
# Test file structure
require 'minitest/autorun'

class YourFeatureTest < Minitest::Test
  def setup
    # Test setup code
  end

  def test_positive_scenario
    # Test successful operation
    assert_equal expected, actual
  end

  def test_negative_scenario
    # Test error conditions
    assert_raises(ExpectedError) do
      # Code that should raise an error
    end
  end

  def test_edge_cases
    # Test boundary conditions
  end
end
```

### Testing Commands
```bash
# Run all tests
bundle exec rake test

# Run specific test file
bundle exec ruby -Itest test/your_test.rb

# Run with coverage (if SimpleCov is configured)
bundle exec rake test COVERAGE=true

# Lint code style
bundle exec rake chefstyle
```

### Platform-Specific Testing Patterns
```ruby
def aix?
  RUBY_PLATFORM.include?('aix')
end

def solaris?
  RUBY_PLATFORM.include?('solaris')
end

def macos?
  RUBY_PLATFORM.include?('darwin')
end

def windows?
  RUBY_PLATFORM.include?('mingw')
end

# Use in tests
def test_platform_specific_feature
  skip("Not applicable on Windows") if windows?
  # Test implementation
end
```

### Required Test Categories
1. **Dependency Override Tests**: Verify version overrides work correctly
2. **FIPS Compliance Tests**: Ensure FIPS mode compatibility
3. **OpenSSL Tests**: Validate OpenSSL versions and functionality
4. **Platform Tests**: Test platform-specific behavior
5. **Integration Tests**: Test omnibus build integration
6. **Error Handling Tests**: Test failure scenarios

## 4. Pull Request Creation Process

### Branch Naming Convention
```bash
# Always use Jira ID as branch name
git checkout -b PROJ-123
```

### Git Workflow with DCO Compliance
```bash
# 1. Create and checkout branch
git checkout -b <JIRA_ID>

# 2. Make changes and stage
git add .

# 3. Commit with DCO signoff (REQUIRED)
git commit --signoff -m "<JIRA_ID>: Brief description of changes"

# 4. Push to remote
git push origin <JIRA_ID>

# 5. Create PR with GH CLI
gh pr create --title "<JIRA_ID>: Descriptive title" \
  --body-file pr_description.md \
  --label "enhancement" \
  --label "Expeditor: Skip Version Bump"
```

### PR Description Template (HTML Format)
```html
<h2>Summary</h2>
<p>Brief description of the changes made to implement [JIRA_ID].</p>

<h2>Jira Ticket</h2>
<p><a href="https://jira.company.com/browse/JIRA_ID">JIRA_ID: Ticket Title</a></p>

<h2>Changes Made</h2>
<ul>
  <li>Updated dependency versions in omnibus_overrides.rb</li>
  <li>Modified chef-foundation.rb project configuration</li>
  <li>Added comprehensive unit tests</li>
  <li>Updated documentation</li>
</ul>

<h2>Testing Performed</h2>
<ul>
  <li>✅ Unit tests: 85% coverage achieved</li>
  <li>✅ FIPS mode compatibility verified</li>
  <li>✅ OpenSSL functionality tested</li>
  <li>✅ Platform-specific testing completed</li>
  <li>✅ Chefstyle linting passed</li>
</ul>

<h2>Files Modified</h2>
<ul>
  <li><code>omnibus_overrides.rb</code></li>
  <li><code>config/projects/chef-foundation.rb</code></li>
  <li><code>test/new_feature_test.rb</code></li>
</ul>

<h2>Verification Steps</h2>
<ol>
  <li>Run test suite: <code>bundle exec rake test</code></li>
  <li>Verify linting: <code>bundle exec rake chefstyle</code></li>
  <li>Test local omnibus build: <code>bundle exec omnibus build chef-foundation</code></li>
</ol>
```

## 5. DCO (Developer Certificate of Origin) Compliance

### **DCO Requirements**
- **ALL commits MUST include DCO signoff**
- **Builds will FAIL without proper DCO signoff**
- **Use `--signoff` flag with every commit**

### DCO Commands
```bash
# New commit with DCO
git commit --signoff -m "JIRA-123: Your commit message"

# Amend last commit to add DCO
git commit --amend --signoff --no-edit

# Sign-off all commits in a branch (if needed)
git rebase --signoff main
```

### Verification
```bash
# Check if commit has DCO signoff
git log --show-signature -1
```

## 6. Build System Integration Analysis

### Expeditor Configuration
The repository uses Expeditor for CI/CD automation with the following key features:

#### Available Skip Labels
- `"Expeditor: Skip All"` - Skip all automation (version bump, changelog, builds)
- `"Expeditor: Skip Version Bump"` - Skip version increment
- `"Expeditor: Skip Changelog"` - Skip changelog update
- `"Expeditor: Skip Omnibus"` - Skip omnibus build pipeline

#### When to Use Skip Labels
- **Documentation changes**: Use `"Expeditor: Skip Version Bump"` and `"Expeditor: Skip Omnibus"`
- **Test-only changes**: Use `"Expeditor: Skip Version Bump"`
- **Build configuration updates**: Use `"Expeditor: Skip Version Bump"`
- **Emergency fixes**: May use `"Expeditor: Skip All"` temporarily

#### Build Channels
- **stable**: Production releases
- **current**: Development builds
- **adhoc**: Manual testing builds

### Build Commands
```bash
# Install dependencies
bundle install --without development

# Run linting
bundle exec rake chefstyle

# Run tests
bundle exec rake test

# Local omnibus build
bundle exec omnibus build chef-foundation

# Clean build cache
bundle exec omnibus clean chef-foundation
```

### Manual Build Triggers
For testing changes before PR approval:
```bash
# Buildkite manual build
bk build create \
  --env='OMNIBUS_FILTER="*linux*"' \
  --pipeline=chef/chef-chef-foundation-main-omnibus-adhoc \
  --branch='your_branch_name'
```

## 7. Label Management System

### Common Repository Labels
Since GitHub CLI authentication is not available, use these standard labels:

#### Change Type Labels
- `enhancement` - New features or improvements
- `bug` - Bug fixes
- `documentation` - Documentation changes
- `maintenance` - Maintenance and refactoring
- `dependencies` - Dependency updates

#### Expeditor Control Labels
- `Expeditor: Skip All`
- `Expeditor: Skip Version Bump`
- `Expeditor: Skip Changelog`
- `Expeditor: Skip Omnibus`
- `Expeditor: Bump Version Minor`
- `Expeditor: Bump Version Major`

#### Priority Labels
- `priority: high`
- `priority: medium`
- `priority: low`

### Label Selection Matrix
| Change Type | Primary Label | Expeditor Label | Notes |
|------------|---------------|-----------------|-------|
| Documentation | `documentation` | `Expeditor: Skip Version Bump` | Skip version and builds |
| Bug fix | `bug` | (none) | Allow normal workflow |
| New feature | `enhancement` | (none) | Allow normal workflow |
| Dependency update | `dependencies` | (none) | Allow normal workflow |
| Test-only | `maintenance` | `Expeditor: Skip Version Bump` | Skip version but allow changelog |
| Build config | `maintenance` | `Expeditor: Skip Version Bump` | Skip version bump |

## 8. Prompt-Based Execution Protocol

### Interaction Pattern
All tasks must follow this prompt-based approach:

1. **Start Phase Announcement**
   ```
   "Starting Phase X: [Phase Name] for [JIRA_ID]. I will:
   - Action 1
   - Action 2
   - Action 3"
   ```

2. **Execute Phase Work**
   - Perform all actions for the current phase
   - Document progress and results

3. **Phase Completion Summary**
   ```
   "Phase X complete. Summary:
   - ✅ Completed action 1
   - ✅ Completed action 2
   - ✅ Completed action 3
   
   Next: Phase Y - [Description]
   
   Do you want me to continue with the next phase?"
   ```

4. **Wait for User Approval**
   - Do not proceed without explicit user confirmation
   - List remaining phases if asked

### Example Interaction Flow
```
Copilot: "Starting Phase 1: Analysis for PROJ-123. I will:
- Fetch Jira ticket details
- Analyze current omnibus configuration
- Plan dependency updates needed"

[Performs work]

Copilot: "Phase 1 complete. Summary:
- ✅ Retrieved Jira ticket: Update OpenSSL to 3.3.0
- ✅ Analyzed current configuration
- ✅ Identified required changes to omnibus_overrides.rb

Next: Phase 2 - Implementation of OpenSSL version update

Do you want me to continue with Phase 2?"

User: "Yes, proceed"

Copilot: "Starting Phase 2: Implementation for PROJ-123..."
```

## 9. Repository-Specific Guidelines

### Omnibus Project Configuration
The main project is defined in `config/projects/chef-foundation.rb`:
- Contains dependency definitions
- Defines packaging configurations for each platform
- Sets installation directories and package metadata

### Version Override Management
Critical file: `omnibus_overrides.rb`
- Contains version pins for all dependencies
- Must be updated when dependency versions change
- Affects all platforms unless platform-specific overrides exist

### Build Environment Requirements
```bash
# Install omnibus-toolchain
curl -fsSL https://omnitruck.chef.io/chef/install.sh | bash -s -- -P "omnibus-toolchain"
export PATH=/opt/omnibus-toolchain/embedded/bin:$PATH

# Install gem dependencies
bundle install --without development

# Verify build environment
bundle exec omnibus version
```

### Container Build Support
```bash
# Using Docker with omnibus-toolchain
docker run -it --privileged \
  --volume $(pwd):/home/chef-foundation \
  gscho/omnibus-toolchain:3.0.0 /bin/bash

cd /home/chef-foundation
export PATH=/opt/omnibus-toolchain/embedded/bin:$PATH
bundle install --without development
bundle exec omnibus build chef-foundation
```

### Platform-Specific Considerations
- **Windows**: Requires MSI packaging, uses specific toolchain
- **macOS**: Uses PKG and DMG packaging, requires signing certificates
- **Linux**: Supports RPM and DEB packaging
- **AIX/Solaris**: Special platform support, limited container builds

## 10. Code Quality & Standards

### Chefstyle Configuration
The repository uses Cookstyle/Chefstyle for Ruby linting:
```bash
# Run style checks
bundle exec rake chefstyle

# Auto-fix style issues
bundle exec cookstyle -a
```

### Ruby Coding Standards
- Follow Chef Ruby style guidelines
- Use frozen string literals
- Prefer explicit return values
- Use descriptive variable names
- Comment complex logic

### License Requirements
- All files must include Apache 2.0 license header
- Copyright notices should reference Chef Software Inc.

### Performance Considerations
- Omnibus builds are resource-intensive
- Use build caching when possible
- Consider platform-specific optimizations
- Monitor build times and resource usage

## 11. Security and Compliance Requirements

### FIPS Compliance
- Test FIPS mode compatibility for all OpenSSL changes
- Verify FIPS algorithms work correctly
- Test FIPS mode enablement/disablement

### CVE Awareness
- Monitor dependency vulnerabilities
- Update dependencies promptly for security issues
- Document security-related changes clearly

### License Compliance
- Ensure all dependencies have compatible licenses
- Update license files when adding new dependencies
- Verify open source license compatibility

## 12. Build & Development Environment

### Local Development Setup
```bash
# 1. Clone repository
git clone https://github.com/chef/chef-foundation.git
cd chef-foundation

# 2. Install omnibus-toolchain
curl -fsSL https://omnitruck.chef.io/chef/install.sh | bash -s -- -P "omnibus-toolchain"
export PATH=/opt/omnibus-toolchain/embedded/bin:$PATH

# 3. Install Ruby dependencies
bundle install --without development

# 4. Verify environment
bundle exec omnibus version
ruby --version
```

### Available Build Commands
```bash
# Clean build
bundle exec omnibus clean chef-foundation

# Full build
bundle exec omnibus build chef-foundation

# Build with specific options
OMNIBUS_FIPS_MODE=true bundle exec omnibus build chef-foundation

# Build for specific platforms (using filters)
OMNIBUS_FILTER="*windows*" bundle exec omnibus build chef-foundation
```

### Troubleshooting Common Issues

#### Build Failures
```bash
# Clear build cache
rm -rf /opt/chef-foundation
bundle exec omnibus clean chef-foundation

# Check for dependency conflicts
bundle check

# Verify omnibus-toolchain installation
/opt/omnibus-toolchain/embedded/bin/ruby --version
```

#### Test Failures
```bash
# Run tests with verbose output
bundle exec rake test TESTOPTS="-v"

# Run specific test
bundle exec ruby -Itest test/specific_test.rb

# Check for platform-specific issues
uname -a
ruby -e "puts RUBY_PLATFORM"
```

## 13. Integration & Dependencies

### Chef Ecosystem Integration
Chef Foundation integrates with:
- **Chef Omnibus**: Consumed as base dependency package
- **Chef**: The main Chef client that uses these dependencies
- **Omnibus Software**: Provides software definitions

### External Dependencies
- **OpenSSL**: Critical security dependency
- **Ruby**: Runtime environment
- **libarchive**: Archive handling
- **nokogiri**: XML/HTML parsing

### Dependency Update Process
```ruby
# In omnibus_overrides.rb
override "openssl", version: "3.3.0"
override "ruby", version: "3.1.4"
override "libarchive", version: "3.7.2"
```

## 14. Release & CI/CD Awareness

### Automated Pipeline Flow
1. **PR Creation**: Triggers verify pipeline
2. **PR Merge**: Triggers version bump and changelog update
3. **Version Bump**: Triggers omnibus release build
4. **Build Success**: Promotes to stable channel
5. **Stable Promotion**: Triggers downstream notifications

### Manual Release Process
For urgent releases:
```bash
# Manual version bump
echo "3.1.1" > VERSION
git add VERSION
git commit --signoff -m "Bump version to 3.1.1"

# Manual changelog update
# Edit CHANGELOG.md manually if needed
```

### Build Notifications
- **Slack Channels**: chef-found-notify, releng-notify
- **Build Status**: Tracked in Buildkite
- **Artifact Promotion**: Managed through Expeditor

## 15. Code Ownership & Review Process

### CODEOWNERS Configuration
- **All files**: @chef/build-engineering-systems-team
- **Expeditor config**: @chef/build-engineering-systems-team
- **Documentation**: @chef/build-engineering-systems-team

### Review Requirements
- All PRs require approval from build engineering team
- Changes to build configuration require additional review
- Security-related changes may require security team review

### Approval Process
1. Submit PR with comprehensive description
2. Automated checks must pass (linting, tests)
3. Manual review by code owners
4. Address review feedback
5. Final approval and merge

## 16. Important Development Notes

### Critical Reminders
- **Work is performed locally** - no remote development environments
- **DCO signoff required** for all commits
- **>80% test coverage mandatory** for all changes
- **Ask for clarification** when requirements are unclear

### Files Never to Modify
- `VERSION` - Auto-generated by Expeditor
- `CHANGELOG.md` - Auto-generated by Expeditor  
- `.expeditor/verify.pipeline.yml` - Managed by build team
- Build artifacts in local directories

### Performance Best Practices
- Use build caching to reduce build times
- Consider platform-specific optimizations
- Monitor resource usage during builds
- Optimize dependency resolution

### Common Issues and Solutions

#### Omnibus Build Failures
- Check available disk space
- Verify omnibus-toolchain installation
- Clear build cache and retry
- Check for platform-specific requirements

#### Test Environment Issues
- Ensure proper Ruby version
- Check for missing system dependencies
- Verify test data and fixtures
- Check platform-specific test skips

## 17. Example Workflow Execution

### Complete Example: OpenSSL Version Update

#### User Request
```
"Please update OpenSSL to version 3.3.0 for PROJ-456"
```

#### Copilot Response Flow
```
Copilot: "Starting Phase 1: Analysis for PROJ-456. I will:
- Fetch Jira ticket details for OpenSSL update
- Analyze current OpenSSL configuration in omnibus_overrides.rb
- Review OpenSSL-related tests and dependencies
- Plan implementation approach with testing strategy"

[Fetches Jira, analyzes current config]

Copilot: "Phase 1 complete. Summary:
- ✅ Retrieved PROJ-456: Update OpenSSL to 3.3.0 for security compliance
- ✅ Current version: 3.2.1 in omnibus_overrides.rb
- ✅ Identified tests: test/open_ssl_test.rb tests version verification
- ✅ Plan: Update override, enhance tests, verify FIPS compatibility

Next: Phase 2 - Implementation of OpenSSL version update

Do you want me to continue with Phase 2?"

User: "Yes, proceed"

Copilot: "Starting Phase 2: Implementation for PROJ-456. I will:
- Update OpenSSL version in omnibus_overrides.rb
- Verify no breaking changes in dependency chain
- Update any version-specific configurations
- Document the change rationale"

[Makes implementation changes]

Copilot: "Phase 2 complete. Summary:
- ✅ Updated omnibus_overrides.rb: OpenSSL 3.2.1 → 3.3.0
- ✅ Verified dependency compatibility
- ✅ No breaking configuration changes required
- ✅ Added comment documenting security compliance reason

Next: Phase 3 - Comprehensive testing (CRITICAL for quality)

Do you want me to continue with Phase 3?"

User: "Yes, continue with testing"

Copilot: "Starting Phase 3: Testing for PROJ-456. This is CRITICAL for quality assurance. I will:
- Run existing OpenSSL tests to verify version update
- Create additional tests for OpenSSL 3.3.0 specific features
- Test FIPS mode compatibility with new version
- Ensure >80% test coverage requirement is met
- Validate no regressions in existing functionality"

[Runs tests, creates new tests, verifies coverage]

Copilot: "Phase 3 complete. Summary:
- ✅ All existing tests pass with OpenSSL 3.3.0
- ✅ Added comprehensive new tests for version verification
- ✅ FIPS mode compatibility verified
- ✅ Test coverage: 87% (exceeds 80% requirement)
- ✅ No regressions detected in test suite
- ✅ Chefstyle linting passed

Next: Phase 4 - Pull Request Creation and Git workflow

Do you want me to continue with Phase 4?"

User: "Yes, create the PR"

Copilot: "Starting Phase 4: Pull Request Creation for PROJ-456. I will:
- Create branch with Jira ID name
- Commit changes with proper DCO signoff
- Push to remote repository
- Create PR with comprehensive HTML description
- Apply appropriate labels for dependency update"

[Executes Git workflow]

Copilot: "Phase 4 complete. Summary:
- ✅ Branch created: PROJ-456
- ✅ Changes committed with DCO signoff
- ✅ Pushed to remote: origin/PROJ-456
- ✅ PR created with comprehensive description
- ✅ Applied labels: 'dependencies', standard workflow labels

Pull request is ready for review by the build engineering team.
All phases completed successfully!"
```

## 18. Technology-Specific Guidelines

### Ruby/Omnibus Development

#### Omnibus Software Definitions
```ruby
# Example software definition pattern
name "example-software"
default_version "1.0.0"

source url: "https://example.com/software.tar.gz",
       sha256: "abc123..."

build do
  configure_command = ["./configure",
                      "--prefix=#{install_dir}/embedded"]
  
  command configure_command.join(" ")
  make "-j #{workers}"
  make "install"
end
```

#### Override Patterns
```ruby
# In omnibus_overrides.rb
override "software-name", version: "1.2.3"
override "software-name", version: "1.2.3", source: { sha256: "abc123..." }

# Platform-specific overrides
if aix?
  override "openssl", version: "3.2.1"
elsif windows?
  override "openssl", version: "3.3.0"
end
```

#### Bundler Management
```bash
# Install dependencies excluding development gems
bundle install --without development

# Update specific gem
bundle update specific-gem

# Check for security vulnerabilities
bundle audit

# Generate Gemfile.lock
bundle lock
```

#### Testing Patterns for Omnibus
```ruby
class OmnibusTest < Minitest::Test
  def setup
    # Load omnibus overrides for testing
    eval(File.read(File.join(__dir__, '../omnibus_overrides.rb')))
  rescue NoMethodError
    # Handle platform-specific methods not available in test environment
  end

  def test_version_override
    assert_match(/3\.3\.0/, @overrides['openssl'])
  end

  def test_platform_specific_behavior
    skip("Not applicable on #{RUBY_PLATFORM}") unless linux?
    # Platform-specific test logic
  end
end
```

## 19. Advanced Configuration Management

### Environment Variables
```bash
# Build configuration
export OMNIBUS_FIPS_MODE=true
export OMNIBUS_WINDOWS_ARCH=x64
export OMNIBUS_USE_INTERNAL_SOURCES=true

# AWS S3 caching
export AWS_ACCESS_KEY_ID=your-key
export AWS_SECRET_ACCESS_KEY=your-secret

# Build filtering
export OMNIBUS_FILTER="*ubuntu*"
```

### Build Configuration Files
- `omnibus.rb` - Global omnibus configuration
- `config/projects/chef-foundation.rb` - Project-specific settings
- `omnibus_overrides.rb` - Version and source overrides

### Cache Management
```bash
# Clear all caches
bundle exec omnibus clean chef-foundation --purge

# Clear specific cache types
rm -rf /opt/chef-foundation
rm -rf ~/.omnibus/cache
```

## Validation Checklist

Before completing any implementation, ensure:

- [ ] Repository structure documented with modification guidelines
- [ ] DCO signoff requirements included in all commit examples
- [ ] >80% test coverage requirement emphasized multiple times
- [ ] Expeditor skip labels documented with use cases
- [ ] Build system integration (Expeditor, Omnibus) documented
- [ ] Prompt-based workflow examples included
- [ ] Ruby/Omnibus-specific testing patterns provided
- [ ] Complete Git workflow with proper DCO commands
- [ ] Security and FIPS compliance requirements covered
- [ ] Troubleshooting section with common issues
- [ ] Example interaction patterns demonstrating workflow

---

**Remember**: This is a CRITICAL infrastructure component for Chef's build system. All changes must be thoroughly tested, properly documented, and follow the established workflow patterns. The >80% test coverage requirement is NON-NEGOTIABLE and must be verified before any PR creation.
